<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Routine Manager</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        table, th, td {
            border: 1px solid black;
            text-align: center;
        }
        th, td {
            padding: 10px;
        }
        .conflict {
            background-color: #ffcccc;
        }
        .break {
            background-color: lightgray;
        }
        .day-btn.active {
            background-color: #007bff;
            color: white;
        }
        .subject-math { background-color: #FFD700; }
        .subject-science { background-color: #90EE90; }
        .subject-english { background-color: #87CEEB; }
        .subject-social { background-color: #FFB6C1; }
        .subject-computer { background-color: #DDA0DD; }
    </style>
</head>
<body class="container mt-4">

    <h2 class="text-center mb-4">School Routine Manager</h2>

    <!-- Day Selection Buttons -->
    <div class="btn-group mb-3">
        <button class="btn btn-outline-primary day-btn active" onclick="switchDay('Sunday')">Sunday</button>
        <button class="btn btn-outline-primary day-btn" onclick="switchDay('Monday')">Monday</button>
        <button class="btn btn-outline-primary day-btn" onclick="switchDay('Tuesday')">Tuesday</button>
        <button class="btn btn-outline-primary day-btn" onclick="switchDay('Wednesday')">Wednesday</button>
        <button class="btn btn-outline-primary day-btn" onclick="switchDay('Thursday')">Thursday</button>
        <button class="btn btn-outline-primary day-btn" onclick="switchDay('Friday')">Friday</button>
    </div>

    <!-- Form Controls -->
    <div class="row mb-3">
        <div class="col-md-4">
            <label for="teacher" class="form-label">Teacher:</label>
            <select id="teacher" class="form-select">
                <option value="T1">T1</option>
                <option value="T2">T2</option>
                <option value="T3">T3</option>
                <option value="T4">T4</option>
                <option value="T5">T5</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="subject" class="form-label">Subject:</label>
            <select id="subject" class="form-select">
                <option value="Math">Math</option>
                <option value="Science">Science</option>
                <option value="English">English</option>
                <option value="Social">Social</option>
                <option value="Computer">Computer</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="class" class="form-label">Class:</label>
            <select id="class" class="form-select">
                <script>
                    for(let i=1; i<=12; i++) {
                        document.write(`<option value="${i}">Class ${i}</option>`);
                    }
                </script>
            </select>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="mb-3">
        <button class="btn btn-primary" onclick="addToRoutine()">Add Assignment</button>
        <button class="btn btn-warning" onclick="resetRoutine()">Reset Current Day</button>
        <button class="btn btn-success" onclick="saveRoutine()">Save All Routines</button>
        <button class="btn btn-info" onclick="exportRoutine()">Export All</button>
        <input type="file" id="importFile" class="d-none" accept=".json">
        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import</button>
    </div>

    <!-- Routine Table -->
    <h3 id="currentDayHeading" class="mt-4">Sunday Routine</h3>
    <table class="table table-bordered">
        <thead id="tableHeader">
            <tr>
                <th>Class</th>
                <!-- Dynamic headers will be inserted here -->
            </tr>
        </thead>
        <tbody id="routineBody">
            <!-- Dynamic content will be inserted here -->
        </tbody>
    </table>

    <!-- Context Menu -->
    <div id="contextMenu" class="dropdown-menu">
        <button class="dropdown-item" onclick="handleEdit()">Edit</button>
        <button class="dropdown-item" onclick="handleDelete()">Delete</button>
    </div>

    <script>
        let currentDay = 'Sunday';
        let selectedCell = null;

        function switchDay(day) {
            currentDay = day;
            document.querySelectorAll('.day-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.textContent === day && btn.classList.add('active');
            });
            document.getElementById('currentDayHeading').textContent = `${day} Routine`;
            rebuildTableStructure();
            loadRoutine();
        }

        function rebuildTableStructure() {
            const isFriday = currentDay === 'Friday';
            const thead = document.querySelector('#tableHeader');
            const tbody = document.querySelector('#routineBody');

            // Build headers
            thead.innerHTML = `
                <tr>
                    <th>Class</th>
                    <th>Period 1</th>
                    <th>Period 2</th>
                    <th>Short Break</th>
                    ${isFriday ? `
                        <th>Period 3</th>
                        <th>Period 4</th>
                        <th>Period 5</th>
                    ` : `
                        <th>Period 3</th>
                        <th>Period 4</th>
                        <th>Lunch Break</th>
                        <th>Period 5</th>
                        <th>Period 6</th>
                        <th>Period 7</th>
                    `}
                </tr>
            `;

            // Build body
            tbody.innerHTML = '';
            for(let classNum=1; classNum<=12; classNum++) {
                const row = document.createElement('tr');
                row.id = `class-${classNum}`;
                row.innerHTML = `
                    <td>Class ${classNum}</td>
                    ${Array.from({length: isFriday ? 6 : 9}, (_, index) => {
                        if(isFriday) {
                            if(index === 2) return '<td class="break">Short Break</td>';
                            const period = index < 2 ? index + 1 : index;
                            return `<td id="class-${classNum}-${period}"></td>`;
                        } else {
                            if(index === 2) return '<td class="break">Short Break</td>';
                            if(index === 5) return '<td class="break">Lunch Break</td>';
                            const period = index < 2 ? index + 1 : index < 5 ? index : index - 1;
                            return `<td id="class-${classNum}-${period}"></td>`;
                        }
                    }).join('')}
                `;
                tbody.appendChild(row);
            }
        }

        function isTeacherAvailable(teacher, period) {
            for (let classNum = 1; classNum <= 12; classNum++) {
                const cellId = `class-${classNum}-${period}`;
                const cell = document.getElementById(cellId);
                if (cell && cell.getAttribute('data-teacher') === teacher) return false;
            }
            return true;
        }

        function addToRoutine() {
            const teacher = document.getElementById("teacher").value;
            const subject = document.getElementById("subject").value;
            const classNumber = document.getElementById("class").value;
            const maxPeriod = currentDay === 'Friday' ? 5 : 7;

            // Check for existing subject in class
            for (let p = 1; p <= maxPeriod; p++) {
                const cell = document.getElementById(`class-${classNumber}-${p}`);
                if (cell && cell.getAttribute('data-subject') === subject) {
                    alert(`Subject ${subject} already exists in Class ${classNumber}`);
                    return;
                }
            }

            // Find available slot
            for (let period = 1; period <= maxPeriod; period++) {
                const cellId = `class-${classNumber}-${period}`;
                const cell = document.getElementById(cellId);
                
                if (cell && cell.innerHTML === "" && isTeacherAvailable(teacher, period)) {
                    cell.innerHTML = `<b>${teacher}</b><br>${subject}`;
                    cell.className = `subject-${subject.toLowerCase()}`;
                    cell.setAttribute("data-teacher", teacher);
                    cell.setAttribute("data-subject", subject);
                    cell.setAttribute("onclick", `editEntry('${cellId}')`);
                    highlightConflicts(teacher);
                    return;
                }
            }
            alert("No available period without conflicts!");
        }

        function editEntry(cellId) {
            const cell = document.getElementById(cellId);
            const oldTeacher = cell.getAttribute("data-teacher");
            const oldSubject = cell.getAttribute("data-subject");
            const [_, classNum, period] = cellId.split('-');

            const newTeacher = prompt("Edit Teacher:", oldTeacher);
            const newSubject = prompt("Edit Subject:", oldSubject);

            if (newTeacher && newSubject) {
                // Check teacher availability
                if (newTeacher !== oldTeacher && !isTeacherAvailable(newTeacher, period)) {
                    alert("Teacher not available in this period!");
                    return;
                }

                // Check subject duplicate
                const maxPeriod = currentDay === 'Friday' ? 5 : 7;
                for (let p = 1; p <= maxPeriod; p++) {
                    const checkCell = document.getElementById(`class-${classNum}-${p}`);
                    if (checkCell && p != period && checkCell.getAttribute('data-subject') === newSubject) {
                        alert("Subject already exists in another period!");
                        return;
                    }
                }

                cell.innerHTML = `<b>${newTeacher}</b><br>${newSubject}`;
                cell.className = `subject-${newSubject.toLowerCase()}`;
                cell.setAttribute("data-teacher", newTeacher);
                cell.setAttribute("data-subject", newSubject);
                highlightConflicts(newTeacher);
            }
        }

        function resetRoutine() {
            if (confirm("Reset current day's routine?")) {
                const maxPeriod = currentDay === 'Friday' ? 5 : 7;
                for (let i = 1; i <= 12; i++) {
                    for (let j = 1; j <= maxPeriod; j++) {
                        const cell = document.getElementById(`class-${i}-${j}`);
                        if (cell) {
                            cell.innerHTML = "";
                            cell.removeAttribute("data-teacher");
                            cell.removeAttribute("data-subject");
                            cell.className = '';
                        }
                    }
                }
            }
        }

        function saveRoutine() {
            const allRoutines = JSON.parse(localStorage.getItem("routines")) || {};
            const routine = {};
            const maxPeriod = currentDay === 'Friday' ? 5 : 7;

            for (let i = 1; i <= 12; i++) {
                routine[`Class ${i}`] = {};
                for (let j = 1; j <= maxPeriod; j++) {
                    const cell = document.getElementById(`class-${i}-${j}`);
                    if (cell && cell.innerHTML !== "") {
                        routine[`Class ${i}`][`Period ${j}`] = {
                            teacher: cell.getAttribute("data-teacher"),
                            subject: cell.getAttribute("data-subject")
                        };
                    }
                }
            }

            allRoutines[currentDay] = routine;
            localStorage.setItem("routines", JSON.stringify(allRoutines));
            alert(`${currentDay} routine saved!`);
        }

        function loadRoutine() {
            const allRoutines = JSON.parse(localStorage.getItem("routines")) || {};
            const routine = allRoutines[currentDay] || {};
            const maxPeriod = currentDay === 'Friday' ? 5 : 7;

            for (let i = 1; i <= 12; i++) {
                for (let j = 1; j <= maxPeriod; j++) {
                    const cell = document.getElementById(`class-${i}-${j}`);
                    if (!cell) continue;
                    
                    const periodData = routine[`Class ${i}`]?.[`Period ${j}`];
                    if (periodData) {
                        cell.innerHTML = `<b>${periodData.teacher}</b><br>${periodData.subject}`;
                        cell.className = `subject-${periodData.subject.toLowerCase()}`;
                        cell.setAttribute("data-teacher", periodData.teacher);
                        cell.setAttribute("data-subject", periodData.subject);
                    } else {
                        cell.innerHTML = "";
                        cell.className = '';
                        cell.removeAttribute("data-teacher");
                        cell.removeAttribute("data-subject");
                    }
                }
            }
        }

        // Context Menu Functions
        document.addEventListener('contextmenu', (e) => {
            if (e.target.tagName === 'TD' && e.target.id.startsWith('class-')) {
                e.preventDefault();
                selectedCell = e.target;
                const menu = document.getElementById('contextMenu');
                menu.style.display = 'block';
                menu.style.left = `${e.pageX}px`;
                menu.style.top = `${e.pageY}px`;
            }
        });

        function handleEdit() {
            if (selectedCell) editEntry(selectedCell.id);
            hideMenu();
        }

        function handleDelete() {
            if (selectedCell) {
                selectedCell.innerHTML = '';
                selectedCell.removeAttribute("data-teacher");
                selectedCell.removeAttribute("data-subject");
                selectedCell.className = '';
                highlightConflicts('');
            }
            hideMenu();
        }

        function hideMenu() {
            document.getElementById('contextMenu').style.display = 'none';
            selectedCell = null;
        }

        function exportRoutine() {
            const routines = localStorage.getItem("routines");
            const dataStr = JSON.stringify(JSON.parse(routines), null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'all_routines.json';
            link.click();
        }

        document.getElementById('importFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                localStorage.setItem("routines", e.target.result);
                loadRoutine();
                alert('Routines imported successfully!');
            };
            reader.readAsText(file);
        });

        function highlightConflicts(teacher) {
            document.querySelectorAll('[data-teacher]').forEach(cell => {
                cell.classList.remove('conflict');
                if (cell.getAttribute('data-teacher') === teacher) {
                    cell.classList.add('conflict');
                }
            });
        }

        // Initialize
        window.onload = () => {
            rebuildTableStructure();
            loadRoutine();
        };
    </script>

</body>
</html>
